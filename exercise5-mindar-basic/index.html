<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Exercise 5 — MindAR basic</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#000; }
    .hud{
      position:fixed; z-index:9999; left:12px; top:12px; right:12px;
      background:rgba(10,10,10,.65); color:#fff; padding:12px 14px;
      border-radius:14px; backdrop-filter: blur(8px);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; align-items:center; }
    .btn, .hud a{
      appearance:none; border:0; cursor:pointer; text-decoration:none;
      background:rgba(255,255,255,.12); color:#fff;
      padding:10px 12px; border-radius:12px; font-weight:800;
    }
    .btn.primary{ background:#22c55e; color:#08130b; }
    .btn.danger{ background:#ef4444; color:#fff; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .small{ opacity:.9; font-size:14px; line-height:1.35; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New"; }
    .status{ margin-top:10px; font-weight:800; }
  </style>
</head>

<body>
  <div class="hud">
    <div><b>Exercise 5 — MindAR (basic)</b></div>
    <div class="small">
      Mostra a imagem alvo em <span class="mono">target.html</span> noutro ecrã.
      <br>Quando o target for detetado, <b>toca/clique no alvo</b> para esconder/mostrar o modelo.
    </div>

    <div class="row">
      <button id="btnStart" class="btn primary">Start AR</button>
      <button id="btnStop" class="btn danger" disabled>Stop</button>
      <a href="./target.html" target="_blank" rel="noopener">Abrir target.html</a>
    </div>

    <div id="status" class="status">Estado: pronto (clica Start AR)</div>
  </div>

  <a-scene
    id="scene"
    mindar-image="imageTargetSrc: ./targets/mindar_target1.mind; autoStart: false;"
    renderer="antialias: true; colorManagement: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-assets>
      <a-asset-item
        id="duck"
        src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Duck/glTF-Binary/Duck.glb">
      </a-asset-item>
    </a-assets>

    <a-camera
      position="0 0 0"
      look-controls="enabled: false"
      cursor="fuse: false; rayOrigin: mouse;"
      raycaster="near: 0.01; far: 10000; objects: .clickable">
    </a-camera>

    <a-entity id="t0" mindar-image-target="targetIndex: 0">
      <!-- Plano invisível para receber clique/tap -->
      <a-plane
        id="clickPlane"
        class="clickable"
        position="0 0 0"
        rotation="0 0 0"
        width="1.2"
        height="0.7"
        color="#ffffff"
        opacity="0.0">
      </a-plane>

      <!-- Modelo -->
      <a-gltf-model
        id="model"
        src="#duck"
        position="0 0 0"
        rotation="0 0 0"
        scale="0.6 0.6 0.6"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 4500">
      </a-gltf-model>

      <!-- Fallback (caso o .glb falhe) -->
      <a-box id="fallbackBox" visible="false" position="0 0.15 0" color="#4CC3D9"></a-box>

      <a-entity
        text="value: toca/clique para mostrar/esconder; color: #111; align: center; width: 2.6;"
        position="0 0.55 0">
      </a-entity>
    </a-entity>
  </a-scene>

  <script>
    const sceneEl = document.querySelector("#scene");
    const statusEl = document.querySelector("#status");
    const btnStart = document.querySelector("#btnStart");
    const btnStop  = document.querySelector("#btnStop");

    const targetEl = document.querySelector("#t0");
    const plane    = document.querySelector("#clickPlane");
    const model    = document.querySelector("#model");
    const fallback = document.querySelector("#fallbackBox");

    let modelVisible = true;

    function setStatus(txt) { statusEl.textContent = "Estado: " + txt; }

    // Target found/lost
    targetEl.addEventListener("targetFound", () => setStatus("TARGET DETETADO ✅ (toca/clique para toggle)"));
    targetEl.addEventListener("targetLost",  () => setStatus("à procura do target…"));

    // Modelo carregou / falhou
    model.addEventListener("model-loaded", () => {
      fallback.setAttribute("visible", false);
    });
    model.addEventListener("model-error", () => {
      console.warn("Falha a carregar o modelo. A usar fallback.");
      fallback.setAttribute("visible", true);
      model.setAttribute("visible", false);
    });

    // Toggle ao clicar/tocar no alvo
    plane.addEventListener("click", () => {
      modelVisible = !modelVisible;
      model.setAttribute("visible", modelVisible);
      if (fallback.getAttribute("visible")) {
        // se estamos em fallback, alterna o fallback em vez do modelo
        fallback.setAttribute("visible", !fallback.getAttribute("visible"));
      }
      setStatus(modelVisible ? "modelo visível" : "modelo escondido");
    });

    // Start/Stop MindAR
    btnStart.addEventListener("click", async () => {
      try {
        btnStart.disabled = true;
        setStatus("a iniciar câmara / MindAR…");
        const sys = sceneEl.systems["mindar-image-system"];
        await sys.start();
        btnStop.disabled = false;
        setStatus("à procura do target…");
      } catch (e) {
        console.error(e);
        btnStart.disabled = false;
        setStatus("ERRO a iniciar (vê Console). Provável: WebGL/perm.)");
      }
    });

    btnStop.addEventListener("click", async () => {
      try {
        btnStop.disabled = true;
        setStatus("a parar…");
        const sys = sceneEl.systems["mindar-image-system"];
        await sys.stop();
        btnStart.disabled = false;
        setStatus("parado (clica Start AR)");
      } catch (e) {
        console.error(e);
        btnStart.disabled = false;
        setStatus("ERRO a parar (vê Console).");
      }
    });

    sceneEl.addEventListener("loaded", () => setStatus("pronto (clica Start AR)"));
  </script>
</body>
</html>
